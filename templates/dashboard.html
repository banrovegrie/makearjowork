<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Arjo Work</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #2d2d2d;
            --text: #ffffff;
            --text-user: #c8c8c8;
            --text-system: #707070;
            --accent: #10b981;
            --border: #333;
            --user-marker: #6366f1;
            --pending: #f59e0b;
            --progress: #3b82f6;
            --done: #10b981;
        }


        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* Nav */
        .nav {
            height: 44px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .nav-brand {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: var(--text-system);
        }

        .nav-link {
            color: var(--text-system);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .nav-link:hover { color: var(--text); }

        .nav-link svg {
            width: 16px;
            height: 16px;
        }

        /* Layout */
        .layout {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Terminal Panel */
        .terminal {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            border-right: 1px solid var(--border);
        }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-size: 13px;
            line-height: 1.7;
        }

        .terminal-output::-webkit-scrollbar { width: 8px; }
        .terminal-output::-webkit-scrollbar-track { background: var(--bg); }
        .terminal-output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        .line {
            margin-bottom: 16px;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* User message - slightly muted */
        .line-user {
            color: var(--text-user);
        }

        .line-user::before {
            content: 'â€º ';
            color: var(--user-marker);
            font-weight: bold;
        }

        /* Assistant message - full white with markdown */
        .line-assistant {
            color: var(--text);
            padding-left: 18px;
            word-break: break-word;
        }

        .line-assistant strong {
            color: #fff;
            font-weight: 600;
        }

        .line-assistant em {
            font-style: italic;
            color: #d4d4d4;
        }

        .line-assistant code {
            font-family: inherit;
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            color: #e879f9;
        }

        .line-assistant pre {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            color: #d4d4d4;
        }

        .line-assistant pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .line-assistant ul, .line-assistant ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .line-assistant li {
            margin: 4px 0;
        }

        .line-assistant a {
            color: var(--accent);
            text-decoration: underline;
        }

        .line-assistant blockquote {
            border-left: 3px solid var(--border);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--text-user);
        }

        .line-assistant .para-break {
            display: block;
            height: 8px;
        }

        /* System message - gray */
        .line-system {
            color: var(--text-system);
            padding-left: 18px;
            font-style: italic;
        }

        /* Action cards */
        .action-card {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            margin: 8px 0 16px 18px;
            border-radius: 0 6px 6px 0;
        }

        .action-card.deleted {
            border-left-color: #ef4444;
        }

        .action-card.updated {
            border-left-color: var(--progress);
        }

        .action-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .action-card.deleted .action-label { color: #ef4444; }
        .action-card.updated .action-label { color: var(--progress); }

        .action-title {
            color: var(--text);
            font-weight: 500;
        }

        /* Typing indicator - gray */
        .typing {
            color: var(--text-system);
            padding-left: 18px;
        }

        .typing::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Welcome */
        .welcome {
            color: var(--text-system);
            padding: 32px 0;
        }

        .welcome h2 {
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .welcome p {
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .welcome-cmd {
            color: var(--text-system);
            margin: 4px 0;
        }

        .welcome-cmd code {
            color: var(--text);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Input */
        .terminal-input {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            position: relative;
        }

        /* Command hints dropdown */
        .hints {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 0;
            min-width: 200px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
        }

        .hints.active { display: block; }

        .hint {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .hint:hover, .hint.selected {
            background: var(--bg-tertiary);
        }

        .hint-cmd {
            color: var(--accent);
            font-weight: 500;
        }

        .hint-desc {
            color: var(--text-system);
            font-size: 11px;
        }

        .prompt {
            color: var(--accent);
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            outline: none;
        }

        .input::placeholder { color: var(--text-system); }

        /* Tasks Panel */
        .tasks {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .tasks-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .tasks-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
        }

        .tasks-stats {
            display: flex;
            gap: 8px;
        }

        .stat {
            flex: 1;
            background: var(--bg);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-value.pending { color: var(--pending); }
        .stat-value.progress { color: var(--progress); }
        .stat-value.done { color: var(--done); }

        .stat-label {
            font-size: 9px;
            color: var(--text-system);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .tasks-filters {
            display: flex;
            gap: 4px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
        }

        .filter {
            padding: 4px 10px;
            font-size: 11px;
            font-family: inherit;
            background: transparent;
            color: var(--text-system);
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter:hover { color: var(--text-user); }

        .filter.active {
            background: var(--bg-tertiary);
            color: var(--text);
            border-color: var(--border);
        }

        .tasks-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .task {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .task:hover { border-color: var(--text-system); }

        .task-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .task-check {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-system);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
            cursor: pointer;
            transition: all 0.1s;
        }

        .task-check:hover { border-color: var(--done); }
        .task-check.checked { background: var(--done); border-color: var(--done); }
        .task-check svg { width: 10px; height: 10px; color: var(--bg); opacity: 0; }
        .task-check.checked svg { opacity: 1; }

        .task-info { flex: 1; min-width: 0; }

        .task-title {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .task.done .task-title {
            color: var(--text-system);
            text-decoration: line-through;
        }

        .task-meta {
            font-size: 10px;
            color: var(--text-system);
        }

        .task-status {
            display: inline-block;
            padding: 1px 5px;
            font-size: 9px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 6px;
        }

        .task-status.pending { background: rgba(245, 158, 11, 0.2); color: var(--pending); }
        .task-status.in_progress { background: rgba(59, 130, 246, 0.2); color: var(--progress); }
        .task-status.done { background: rgba(16, 185, 129, 0.2); color: var(--done); }
        .task-status.EVENT { background: rgba(99, 102, 241, 0.2); color: #6366f1; }
        .task.event { border-left: 3px solid #6366f1; }
        .task.event .task-check { background: rgba(99, 102, 241, 0.1); border-color: #6366f1; }

        .empty-tasks {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-system);
            font-size: 12px;
        }

        /* Task description expand */
        .task-description {
            display: none;
            padding: 8px 12px 4px 38px;
            font-size: 12px;
            color: var(--text-user);
            line-height: 1.5;
            border-top: 1px solid var(--border);
            margin-top: 8px;
        }

        .task.expanded .task-description {
            display: block;
        }

        /* Mobile hamburger */
        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: 4px;
        }

        .mobile-toggle svg {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .layout { flex-direction: column; position: relative; }
            .terminal {
                border-right: none;
                flex: 1;
                display: flex;
            }
            .tasks {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10;
                display: none;
                max-height: none;
            }
            .tasks.mobile-visible {
                display: flex;
            }
            .tasks-close {
                display: block;
            }
        }

        .tasks-close {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-system);
            cursor: pointer;
            padding: 4px;
        }

        .tasks-close:hover {
            color: var(--text);
        }

        .tasks-close svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-brand">{{ user.email }}</div>
        <div class="nav-right">
            <button class="mobile-toggle" id="tasks-toggle" title="Tasks">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <a href="/logout" class="nav-link" title="Logout">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </a>
        </div>
    </nav>

    <div class="layout">
        <div class="terminal">
            <div class="terminal-output" id="output">
                <div class="welcome">
                    <h2>Make Arjo Work v1.0</h2>
                    <p>Talk to manage Arjo's tasks. The agent can add, update, complete, and delete tasks.</p>
                    <div class="welcome-cmd"><code>/clear</code> - clear chat history</div>
                    <div class="welcome-cmd"><code>/tasks</code> - show all tasks</div>
                    <p style="margin-top: 12px;">Type <code>/</code> for command hints.</p>
                </div>
            </div>

            <div class="terminal-input">
                <div class="hints" id="hints">
                    <div class="hint" data-cmd="/clear">
                        <span class="hint-cmd">/clear</span>
                        <span class="hint-desc">clear chat history</span>
                    </div>
                    <div class="hint" data-cmd="/tasks">
                        <span class="hint-cmd">/tasks</span>
                        <span class="hint-desc">show all tasks</span>
                    </div>
                </div>
                <span class="prompt">â€º</span>
                <input type="text" class="input" id="input" placeholder="Type a message..." autofocus>
            </div>
        </div>

        <div class="tasks" id="tasks-panel">
            <button class="tasks-close" id="tasks-close">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg>
            </button>
            <div class="tasks-header">
                <div class="tasks-title">Arjo's Tasks</div>
                <div class="tasks-stats">
                    <div class="stat">
                        <div class="stat-value pending" id="pending-count">0</div>
                        <div class="stat-label">pending</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value progress" id="progress-count">0</div>
                        <div class="stat-label">active</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value done" id="done-count">0</div>
                        <div class="stat-label">done</div>
                    </div>
                </div>
            </div>

            <div class="tasks-filters">
                <button class="filter active" data-filter="all">all</button>
                <button class="filter" data-filter="pending">pending</button>
                <button class="filter" data-filter="in_progress">active</button>
                <button class="filter" data-filter="done">done</button>
            </div>

            <div class="tasks-list" id="tasks-list"></div>
        </div>
    </div>


    <script>
        let tasks = [];
        let currentFilter = 'all';
        let isLoading = false;

        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const hints = document.getElementById('hints');
        const hintItems = hints.querySelectorAll('.hint');
        let selectedHint = -1;

        loadHistory();
        loadTasks();

        // Ensure input is focused on page load
        input.focus();

        // Handle input changes for hints
        input.addEventListener('input', () => {
            const val = input.value;
            if (val.startsWith('/')) {
                const filter = val.toLowerCase();
                let visibleCount = 0;
                hintItems.forEach(h => {
                    const cmd = h.dataset.cmd;
                    if (cmd.startsWith(filter)) {
                        h.style.display = 'flex';
                        visibleCount++;
                    } else {
                        h.style.display = 'none';
                    }
                });
                if (visibleCount > 0) {
                    hints.classList.add('active');
                    selectedHint = -1;
                    updateHintSelection();
                } else {
                    hints.classList.remove('active');
                }
            } else {
                hints.classList.remove('active');
            }
        });

        // Handle keyboard navigation
        input.addEventListener('keydown', e => {
            if (hints.classList.contains('active')) {
                const visible = Array.from(hintItems).filter(h => h.style.display !== 'none');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedHint = Math.min(selectedHint + 1, visible.length - 1);
                    updateHintSelection();
                    return;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedHint = Math.max(selectedHint - 1, -1);
                    updateHintSelection();
                    return;
                } else if (e.key === 'Tab' && visible.length > 0) {
                    e.preventDefault();
                    const idx = selectedHint >= 0 ? selectedHint : 0;
                    input.value = visible[idx].dataset.cmd;
                    hints.classList.remove('active');
                    return;
                } else if (e.key === 'Escape') {
                    hints.classList.remove('active');
                    return;
                }
            }
            // Enter sends message (even if hints showing but nothing selected)
            if (e.key === 'Enter' && !isLoading) {
                hints.classList.remove('active');
                sendMessage();
            }
        });

        // Auto-focus input when typing anywhere
        document.addEventListener('keydown', e => {
            // Ignore if already in input or modifier keys
            if (document.activeElement === input) return;
            if (e.ctrlKey || e.metaKey || e.altKey) return;
            // Ignore special keys
            if (['Escape', 'Tab', 'Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) return;
            // Focus and let the key through
            input.focus();
        });

        // Click on hint
        hintItems.forEach(h => {
            h.addEventListener('click', () => {
                input.value = h.dataset.cmd;
                hints.classList.remove('active');
                input.focus();
            });
        });

        function updateHintSelection() {
            const visible = Array.from(hintItems).filter(h => h.style.display !== 'none');
            hintItems.forEach(h => h.classList.remove('selected'));
            if (selectedHint >= 0 && visible[selectedHint]) {
                visible[selectedHint].classList.add('selected');
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/chat/history');
                const history = await res.json();
                if (Array.isArray(history) && history.length > 0) {
                    output.innerHTML = '';
                    history.forEach(msg => {
                        if (msg && msg.role && msg.content) {
                            addLine(msg.role, msg.content);
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text || isLoading) return;

            if (text === '/clear') {
                await fetch('/api/chat/clear', { method: 'POST' });
                output.innerHTML = '';
                addLine('system', 'Chat cleared.');
                input.value = '';
                return;
            }

            if (text === '/tasks') {
                const pending = tasks.filter(t => t.status === 'pending').length;
                const active = tasks.filter(t => t.status === 'in_progress').length;
                const done = tasks.filter(t => t.status === 'done').length;
                let summary = `**Tasks:** ${pending} pending, ${active} active, ${done} done\n\n`;
                if (tasks.length === 0) {
                    summary += 'No tasks yet.';
                } else {
                    tasks.forEach(t => {
                        const status = { pending: 'â—‹', in_progress: 'â—', done: 'â—' }[t.status] || 'â—‹';
                        summary += `${status} #${t.id || '?'} ${t.title || 'Untitled'}\n`;
                    });
                }
                addLine('assistant', summary.trim());
                input.value = '';
                return;
            }

            const welcome = output.querySelector('.welcome');
            if (welcome) welcome.remove();

            addLine('user', text);
            input.value = '';

            const typingEl = document.createElement('div');
            typingEl.className = 'typing';
            typingEl.textContent = 'thinking';
            output.appendChild(typingEl);
            scrollToBottom();

            isLoading = true;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                const data = await res.json();
                typingEl.remove();

                if (data.error) {
                    addLine('system', `Error: ${data.error}`);
                } else {
                    // Display response (function calls handled server-side)
                    if (data.response) {
                        addLine('assistant', data.response);
                    }

                    // Show action cards
                    if (data.actions && data.actions.length > 0) {
                        data.actions.forEach(action => {
                            addActionCard(action);
                        });
                        loadTasks();
                    }
                }
            } catch (err) {
                typingEl.remove();
                addLine('system', `Error: ${err.message}`);
            }

            isLoading = false;
            input.focus();
        }

        function addLine(role, content) {
            const el = document.createElement('div');
            el.className = `line line-${role}`;

            if (role === 'assistant') {
                el.innerHTML = renderMarkdown(content);
            } else {
                el.textContent = content;
            }

            output.appendChild(el);
            scrollToBottom();
        }

        function addActionCard(action) {
            // Skip actions without task data (like clarification)
            if (!action.task) return;

            const el = document.createElement('div');
            el.className = `action-card ${action.type}`;

            const labels = {
                added: 'Task Added',
                updated: 'Task Updated',
                done: 'Task Completed',
                deleted: 'Task Deleted'
            };

            el.innerHTML = `
                <div class="action-label">${labels[action.type] || action.type}</div>
                <div class="action-title">${escapeHtml(action.task.title)}</div>
            `;
            output.appendChild(el);
            scrollToBottom();
        }

        function renderMarkdown(text) {
            let html = escapeHtml(text);

            // Code blocks (must be first)
            html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // Unordered lists - mark with placeholder to avoid newline issues
            html = html.replace(/^[\-\*] (.+)$/gm, '[[UL_ITEM]]$1[[/UL_ITEM]]');

            // Ordered lists - mark with placeholder
            html = html.replace(/^\d+\. (.+)$/gm, '[[OL_ITEM]]$1[[/OL_ITEM]]');

            // Blockquotes
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

            // Paragraph breaks (double newline) - use spacer span
            html = html.replace(/\n\n+/g, '<span class="para-break"></span>');
            // Single line breaks
            html = html.replace(/\n/g, '<br>');

            // Clean up extra breaks in pre
            html = html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
                return '<pre><code>' + code.replace(/<br>/g, '\n') + '</code></pre>';
            });

            // Now convert list placeholders to proper HTML (after br conversion)
            html = html.replace(/\[\[UL_ITEM\]\](.+?)\[\[\/UL_ITEM\]\]/g, '<li>$1</li>');
            html = html.replace(/\[\[OL_ITEM\]\](.+?)\[\[\/OL_ITEM\]\]/g, '<li class="ol">$1</li>');

            // Wrap consecutive list items
            html = html.replace(/(<li>.*?<\/li>(<br>)?)+/g, match => {
                return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
            });
            html = html.replace(/(<li class="ol">.*?<\/li>(<br>)?)+/g, match => {
                return '<ol>' + match.replace(/<br>/g, '').replace(/ class="ol"/g, '') + '</ol>';
            });

            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }

        // Tasks
        async function loadTasks() {
            try {
                const res = await fetch('/api/tasks');
                const data = await res.json();
                tasks = Array.isArray(data) ? data : [];
                renderTasks();
                updateStats();
            } catch (err) {
                console.error('Failed to load tasks:', err);
                tasks = [];
                renderTasks();
            }
        }

        function renderTasks() {
            const list = document.getElementById('tasks-list');
            let filtered;
            if (currentFilter === 'all') {
                filtered = tasks;
            } else if (currentFilter === 'pending') {
                // Include both pending tasks and calendar events
                filtered = tasks.filter(t => t.status === 'pending' || t.status === 'EVENT');
            } else {
                filtered = tasks.filter(t => t.status === currentFilter);
            }

            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-tasks">No tasks</div>';
                return;
            }

            list.innerHTML = filtered.map(task => {
                if (!task) return '';
                const status = task.status || 'pending';
                const isEvent = status === 'EVENT';
                const eventTime = isEvent && task.event_start ? formatEventTime(task.event_start) : '';
                const taskId = isEvent ? `'${task.id}'` : task.id;
                const title = task.title || 'Untitled';
                const assignedBy = task.assigned_by || 'unknown';

                return `
                <div class="task ${status === 'done' ? 'done' : ''} ${isEvent ? 'event' : ''}" data-id="${task.id}" onclick="toggleDescription(${taskId})">
                    <div class="task-row">
                        <div class="task-check ${status === 'done' ? 'checked' : ''}" ${isEvent ? '' : `onclick="event.stopPropagation(); toggleTask(${task.id}, ${status !== 'done'})"`}>
                            ${isEvent ? 'ðŸ“…' : `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>`}
                        </div>
                        <div class="task-info">
                            <div class="task-title">${escapeHtml(title)}</div>
                            <div class="task-meta">
                                ${isEvent ? eventTime : `#${task.id} Â· ${assignedBy} Â· ${formatDate(task.created_at)}`}
                                <span class="task-status ${status}">${formatStatus(status)}</span>
                            </div>
                        </div>
                    </div>
                    ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                </div>`;
            }).join('');
        }

        function updateStats() {
            document.getElementById('pending-count').textContent = tasks.filter(t => t.status === 'pending').length;
            document.getElementById('progress-count').textContent = tasks.filter(t => t.status === 'in_progress').length;
            document.getElementById('done-count').textContent = tasks.filter(t => t.status === 'done').length;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatEventTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const tomorrow = new Date(now.getTime() + 86400000);
            const isTomorrow = date.toDateString() === tomorrow.toDateString();
            const time = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            if (isToday) return `Today at ${time}`;
            if (isTomorrow) return `Tomorrow at ${time}`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ` at ${time}`;
        }

        function formatStatus(status) {
            return { pending: 'pending', in_progress: 'active', done: 'done', EVENT: 'event' }[status] || status;
        }

        async function toggleTask(id, done) {
            await fetch(`/api/tasks/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: done ? 'done' : 'pending' })
            });
            loadTasks();
        }

        function toggleDescription(id) {
            const taskEl = document.querySelector(`.task[data-id="${id}"]`);
            if (taskEl) taskEl.classList.toggle('expanded');
        }

        document.querySelectorAll('.filter').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderTasks();
            });
        });

        // Hide hints when clicking outside
        document.addEventListener('click', e => {
            if (!hints.contains(e.target) && e.target !== input) {
                hints.classList.remove('active');
            }
        });

        // Mobile tasks toggle
        const tasksPanel = document.getElementById('tasks-panel');
        const tasksToggle = document.getElementById('tasks-toggle');
        const tasksClose = document.getElementById('tasks-close');

        tasksToggle.addEventListener('click', () => {
            tasksPanel.classList.add('mobile-visible');
        });

        tasksClose.addEventListener('click', () => {
            tasksPanel.classList.remove('mobile-visible');
        });

    </script>
</body>
</html>
